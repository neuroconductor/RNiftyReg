<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Registration Using the NiftyReg Library • RNiftyReg</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Image Registration Using the NiftyReg Library">
<meta property="og:description" content="Provides an R interface to the NiftyReg image
        registration tools &lt;https://github.com/KCL-BMEIS/niftyreg&gt;.
        Linear and nonlinear registration are supported, in two and
        three dimensions.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">RNiftyReg</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.7.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jonclayden/RNiftyReg/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">


<div id="rniftyreg-nifty-registration-in-r" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#rniftyreg-nifty-registration-in-r" class="anchor" aria-hidden="true"></a>RNiftyReg: Nifty Registration in R</h1></div>
<p>The <code>RNiftyReg</code> package is an R-native interface to the <a href="https://github.com/KCL-BMEIS/niftyreg" class="external-link">NiftyReg image registration library</a>. The package incorporates the library, so it does not need to be installed separately, and it replaces the NiftyReg command-line front-end with a direct, in-memory bridge to R, based on <a href="https://github.com/jonclayden/RNifti" class="external-link">the <code>RNifti</code> package</a>.</p>
<p>This <code>README</code> file primarily covers version 2.0.0 of the package and later. The interface was substantially reworked in that version to make it more natural and less verbose, and earlier versions are incompatible. Information on <a href="#upgrading-to-rniftyreg-2x">moving from prior versions of <code>RNiftyReg</code> to 2.x</a> is included at the end of this file.</p>
<p>The package can be installed from CRAN, or the latest development version obtained directly from GitHub:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## install.packages("remotes")</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"jonclayden/RNiftyReg"</span><span class="op">)</span></code></pre></div>
<p>The <a href="https://github.com/jonclayden/mmand" class="external-link"><code>mmand</code> package</a> for image processing may also be useful, and is used in some of the examples below.</p>
<div id="contents" class="section level2">
<h2 class="hasAnchor">
<a href="#contents" class="anchor" aria-hidden="true"></a>Contents</h2>
<ul>
<li><a href="#reading-and-writing-images">Reading and writing images</a></li>
<li><a href="#image-registration">Image registration</a></li>
<li><a href="#applying-and-manipulating-transformations">Applying and manipulating transformations</a></li>
<li><a href="#convenience-functions">Convenience functions</a></li>
<li><a href="#upgrading-to-rniftyreg-2x">Upgrading to RNiftyReg 2.x</a></li>
</ul>
</div>
<div id="reading-and-writing-images" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-and-writing-images" class="anchor" aria-hidden="true"></a>Reading and writing images</h2>
<p><code>RNiftyReg</code> may be used to register and manipulate two and three dimensional images of any sort, although its origins are in medical imaging. Medical images in the standard <a href="http://nifti.nimh.nih.gov/nifti-1" class="external-link">NIfTI-1 format</a> may be read into R using the <code>readNifti</code> function, which is based on the first-party <a href="https://github.com/jonclayden/RNifti" class="external-link"><code>RNifti</code> package</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonclayden/RNiftyReg" class="external-link">RNiftyReg</a></span><span class="op">)</span>
<span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/readNifti.html">readNifti</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"epi_t2.nii.gz"</span>, package<span class="op">=</span><span class="st">"RNiftyReg"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This image is an R array with some additional attributes containing information such as its dimensions and the size of its pixels (or voxels, in this case, since it is a 3D image).</p>
<p>As mentioned above, however, images do not have to be in NIfTI-1 format. Any numeric matrix or array can be used, and standard image formats such as JPEG and PNG can be read in using additional packages. For example,</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## install.packages("jpeg")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rforge.net/jpeg/" class="external-link">jpeg</a></span><span class="op">)</span>
<span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/jpeg/man/readJPEG.html" class="external-link">readJPEG</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"house_colour_large.jpg"</span>, package<span class="op">=</span><span class="st">"RNiftyReg"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Complementary <code>writeNifti</code> and <code>writeJPEG</code> functions are provided by the <code>RNifti</code> and <code>jpeg</code> packages, respectively.</p>
</div>
<div id="image-registration" class="section level2">
<h2 class="hasAnchor">
<a href="#image-registration" class="anchor" aria-hidden="true"></a>Image registration</h2>
<p>Once two or more images have been read into R, they can be registered. Registration is the dual operation of searching a space of transformations for the best way to align two images, and then resampling one image onto the grid of the other. The images need not be the same size or in the same orientation.</p>
<p>There are two main classes of transformation available: linear and nonlinear. Linear, and specifically <em>affine</em>, transforms can represent translation, scaling and rotation in 2D or 3D space. They have up to 12 degrees of freedom and are appropriate to capture global shifts between images. Nonlinear transformations have many more degrees of freedom, and can capture localised distortions between images, but they are more time-consuming to estimate and more complex to work with.</p>
<p>Some sample 3D medical images are included with the package. We begin by registering two brain scan images, of the same person, with different contrasts. First we read them in, and then we pass them to the package’s core registration function, <code>niftyreg</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">source</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/readNifti.html">readNifti</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"epi_t2.nii.gz"</span>, package<span class="op">=</span><span class="st">"RNiftyReg"</span><span class="op">)</span><span class="op">)</span>
<span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/readNifti.html">readNifti</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"flash_t1.nii.gz"</span>, package<span class="op">=</span><span class="st">"RNiftyReg"</span><span class="op">)</span><span class="op">)</span>

<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/niftyreg.html">niftyreg</a></span><span class="op">(</span><span class="va">source</span>, <span class="va">target</span><span class="op">)</span></code></pre></div>
<p>The last command will take a few seconds to complete. The <code>result</code> is a list with a number of components, the most important of which is the resampled source image in target space, <code>result$image</code>.</p>
<p>By default the transformation will be an affine matrix. If we want to allow for a nonlinear transformation, with scope for local deformations between one space and the other, we can perform an additional registration as follows.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/niftyreg.html">niftyreg</a></span><span class="op">(</span><span class="va">source</span>, <span class="va">target</span>, scope<span class="op">=</span><span class="st">"nonlinear"</span>, init<span class="op">=</span><span class="fu"><a href="reference/forward.html">forward</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Notice the <code>scope</code> argument, and also the fact that we use the result of the previous linear registration to initialise the nonlinear one. (The <code>forward</code> function extracts the forward transformation from the previous registration.) This should result in reduced convergence time, since the affine transformation provides a first approximation for the nonlinear registration algorithm. Nevertheless, this algorithm will generally take longer to complete.</p>
</div>
<div id="applying-and-manipulating-transformations" class="section level2">
<h2 class="hasAnchor">
<a href="#applying-and-manipulating-transformations" class="anchor" aria-hidden="true"></a>Applying and manipulating transformations</h2>
<p>Once a transformation between two images has been established through registration, it can be extracted, applied to another image or pixel coordinates, or manipulated. Transformations can also be read from or written to file, or created from scratch. Registration is by default symmetric, meaning that forward and reverse transformations are calculated simultaneously. These can be extracted using the <code>forward</code> and <code>reverse</code> functions.</p>
<p>Let’s use a simple image by way of example. We will need the <code>jpeg</code> package to read it in, and the <code>mmand</code> package (version 1.2.0 or later) to visualise it.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## install.packages(c("jpeg","mmand"))</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rforge.net/jpeg/" class="external-link">jpeg</a></span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonclayden/mmand" class="external-link">mmand</a></span><span class="op">)</span>
<span class="co">## </span>
<span class="co">## Attaching package: 'mmand'</span>
<span class="co">## The following object is masked from 'package:RNiftyReg':</span>
<span class="co">## </span>
<span class="co">##     rescale</span>

<span class="va">house</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/jpeg/man/readJPEG.html" class="external-link">readJPEG</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"house_colour_large.jpg"</span>, package<span class="op">=</span><span class="st">"RNiftyReg"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mmand/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">house</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/house-1.png" alt=""><p class="caption">plot of chunk house</p>
</div>
<p>Clearly this is a colour image, with red, green and blue channels. <code>RNiftyReg</code> can work with it in this format, but internally the channels will be averaged before the registration starts. This step performs a colour-to-greyscale conversion equivalent to</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">house_bw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">house</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mmand/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">house_bw</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/house-bw-1.png" alt=""><p class="caption">plot of chunk house-bw</p>
</div>
<p>Now, instead of registering the image to another image, let’s create a simple affine transformation that applies a skew to the image.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">affine</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/buildAffine.html">buildAffine</a></span><span class="op">(</span>skews<span class="op">=</span><span class="fl">0.1</span>, source<span class="op">=</span><span class="va">house</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">affine</span><span class="op">)</span>
<span class="co">## NiftyReg affine matrix:</span>
<span class="co">##  1.0  -0.1   0.0   0.0</span>
<span class="co">##  0.0   1.0   0.0   0.0</span>
<span class="co">##  0.0   0.0   1.0   0.0</span>
<span class="co">##  0.0   0.0   0.0   1.0</span>
<span class="co">## Source origin: (1, 1, 1)</span>
<span class="co">## Target origin: (1, 1, 1)</span></code></pre></div>
<p>So, this is a diagonal matrix with just a single off-diagonal element, which produces the skew effect. (The sign is negative because NiftyReg actually represents transforms from target to source space, not the more intuitive reverse.) Let’s apply it to the image using the important <code>applyTransform</code> function, and see the effect.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">house_skewed</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/applyTransform.html">applyTransform</a></span><span class="op">(</span><span class="va">affine</span>, <span class="va">house</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mmand/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">house_skewed</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/house-skewed-1.png" alt=""><p class="caption">plot of chunk house-skewed</p>
</div>
<p>Moreover, we can transform a pixel coordinate into the space of the skewed image:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/applyTransform.html">applyTransform</a></span><span class="op">(</span><span class="va">affine</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">182</span>,<span class="fl">262</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co">## [1] 208.1 262.0   1.0</span></code></pre></div>
<p>Notice that the skew changes the first coordinate (in the up-down direction), but not the second (in the left-right direction) or third (the colour channel number).</p>
<p>Finally, we can register the original image to the skewed one, to recover the transformation:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/niftyreg.html">niftyreg</a></span><span class="op">(</span><span class="va">house</span>, <span class="va">house_skewed</span>, scope<span class="op">=</span><span class="st">"affine"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="reference/forward.html">forward</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span>
<span class="co">## NiftyReg affine matrix:</span>
<span class="co">##  1.0008598566  -0.0992648527   0.0000000000  -0.2597596645</span>
<span class="co">## -0.0009524839   0.9996437430   0.0000000000   0.3225949407</span>
<span class="co">##  0.0000000000   0.0000000000   1.0000000000   0.0000000000</span>
<span class="co">##  0.0000000000   0.0000000000   0.0000000000   1.0000000000</span>
<span class="co">## Source origin: (1, 1, 1)</span>
<span class="co">## Target origin: (1, 1, 1)</span></code></pre></div>
<p>Notice that the estimated transformation closely approximates the generative one, with the element in row 1, column 2 being very close to -0.1. We can decompose this estimated transformation and recover the skew component:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/decomposeAffine.html">decomposeAffine</a></span><span class="op">(</span><span class="fu"><a href="reference/forward.html">forward</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">skews</span>
<span class="co">##        xy        xz        yz </span>
<span class="co">## 0.1001419 0.0000000 0.0000000</span></code></pre></div>
<p>Two other manipulations can be helpful to know about. The first is calculating a half-transform, which can be used to transform the image into a space halfway to the target. For example, using our registration result from above,</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">half_xfm</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/halfTransform.html">halfTransform</a></span><span class="op">(</span><span class="fu"><a href="reference/forward.html">forward</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mmand/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="fu"><a href="reference/applyTransform.html">applyTransform</a></span><span class="op">(</span><span class="va">half_xfm</span>, <span class="va">house</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/house-halfskewed-1.png" alt=""><p class="caption">plot of chunk house-halfskewed</p>
</div>
<p>This results in half of the skew effect being applied. Finally, the <code>composeTransforms</code> function allows the effects of two transforms to be combined together. Combining a half-transform with itself will result in the original full transform.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="reference/forward.html">forward</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>, <span class="fu"><a href="reference/composeTransforms.html">composeTransforms</a></span><span class="op">(</span><span class="va">half_xfm</span>,<span class="va">half_xfm</span><span class="op">)</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## [1] TRUE</span></code></pre></div>
</div>
<div id="convenience-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#convenience-functions" class="anchor" aria-hidden="true"></a>Convenience functions</h2>
<p>The package provides a group of convenience functions—<code>translate</code>, <code>rescale</code>, <code>skew</code> and <code>rotate</code>—which can be used to quickly apply simple transformations to an image. For example, the skew operation applied above can be more compactly written as</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">house_skewed</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/translate.html">skew</a></span><span class="op">(</span><span class="va">house</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mmand/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">house_skewed</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/house-reskewed-1.png" alt=""><p class="caption">plot of chunk house-reskewed</p>
</div>
<p>Since these take the image as their first argument, they are compatible with the chaining operator from the <a href="https://cran.r-project.org/package=magrittr" class="external-link">popular <code>magrittr</code> package</a>. However, because such a chain applies multiple transformations to an image, there may be a loss of precision, or of data, compared to a single more complex operation. For example, while</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span>
<span class="va">house_transformed</span> <span class="op">&lt;-</span> <span class="va">house</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="reference/translate.html">rotate</a></span><span class="op">(</span><span class="va">pi</span><span class="op">/</span><span class="fl">4</span>, anchor<span class="op">=</span><span class="st">"centre"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="reference/translate.html">translate</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mmand/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">house_transformed</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/house-transformed1-1.png" alt=""><p class="caption">plot of chunk house-transformed1</p>
</div>
<p>is much more readable than</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xfm</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/composeTransforms.html">composeTransforms</a></span><span class="op">(</span><span class="fu"><a href="reference/buildAffine.html">buildAffine</a></span><span class="op">(</span>angles<span class="op">=</span><span class="va">pi</span><span class="op">/</span><span class="fl">4</span>, anchor<span class="op">=</span><span class="st">"centre"</span>, source<span class="op">=</span><span class="va">house</span><span class="op">)</span>, <span class="fu"><a href="reference/buildAffine.html">buildAffine</a></span><span class="op">(</span>translation<span class="op">=</span><span class="fl">30</span>, source<span class="op">=</span><span class="va">house</span><span class="op">)</span><span class="op">)</span>
<span class="va">house_transformed</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/applyTransform.html">applyTransform</a></span><span class="op">(</span><span class="va">xfm</span>, <span class="va">house</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mmand/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">house_transformed</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/house-transformed2-1.png" alt=""><p class="caption">plot of chunk house-transformed2</p>
</div>
<p>the latter avoids the creation of a black band across the top of the final image, since it has access to the full content of the original image, rather than just the truncated version produced by the rotation.</p>
</div>
<div id="upgrading-to-rniftyreg-2x" class="section level2">
<h2 class="hasAnchor">
<a href="#upgrading-to-rniftyreg-2x" class="anchor" aria-hidden="true"></a>Upgrading to RNiftyReg 2.x</h2>
<p><code>RNiftyReg</code> 2.0.0 is a more-or-less complete rewrite of the package, with the goals of simplifying both the package’s dependencies and its usage. The upstream NiftyReg code has also been updated. However, it should still be possible to read and use transformations created using <code>RNiftyReg</code> 1.x.</p>
<p>The core changes are</p>
<ul>
<li>The <code>oro.nifti</code> package is no longer needed, nor used for reading and writing NIfTI files (<code>RNiftyReg</code> now offers <code>readNifti</code> and <code>writeNifti</code>, which are much faster). However, objects of S4 class <code>nifti</code> can still be used with the package if desired. Functions return either plain R arrays with attributes or bare-bones <code>internalImage</code> objects, which contain only some basic metadata and a pointer to a C-level data structure.</li>
<li>There are new functions for halving a transform (<code>halfTransform</code>), composing two transforms (<code>composeTransforms</code>), and building an affine transform from scratch (<code>buildAffine</code>).</li>
<li>Registration is now symmetric by default (for both linear and nonlinear), a newer symmetric nonlinear approach is now used, and default cost function weights have been tweaked. Therefore, the arguments to the core <code>niftyreg</code> function, and its linear and nonlinear special cases, have changed in both name and defaults. See <code><a href="reference/niftyreg.html">?niftyreg</a></code> and related help pages for details.</li>
<li>It is no longer necessary to use functions specific to transform type to perform many operations. For example, the work of the old <code>applyAffine</code>, <code>applyControlPoints</code>, <code>transformWithAffine</code> and <code>transformWithControlPoints</code> functions is done by the flexible new <code>applyTransform</code> function. The forward and reverse transforms can always be obtained from a registration using the new <code>forward</code> and <code>reverse</code> functions, no matter what their type is. However, some affine-only functions, such as <code>decomposeAffine</code>, retain their names.</li>
<li>The <code>affineType</code> attribute has gone, and <code>convertAffine</code> is no longer a user-visible function. All affine matrices are stored using the NiftyReg convention. FSL-FLIRT affines can still be read in, but they are converted to NiftyReg convention immediately. In addition, source and target image information is attached to the transforms in attributes, and so does not need to be specified in most function calls.</li>
</ul>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=RNiftyReg">https://​cloud.r-project.org/​package=RNiftyReg</a>
</li>
<li>Browse source code at <br><a href="https://github.com/jonclayden/RNiftyReg/">https://​github.com/​jonclayden/​RNiftyReg/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/jonclayden/RNiftyReg/issues">https://​github.com/​jonclayden/​RNiftyReg/​issues</a>
</li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a></li>
</ul>
</div>


<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Jon Clayden <br><small class="roles"> Maintainer, author </small> <a href="https://orcid.org/0000-0002-6608-0619" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Marc Modat <br><small class="roles"> Author </small>  </li>
<li>Benoit Presles <br><small class="roles"> Author </small>  </li>
<li>Thanasis Anthopoulos <br><small class="roles"> Author </small>  </li>
<li>Pankaj Daga <br><small class="roles"> Author </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://travis-ci.org/jonclayden/RNiftyReg" class="external-link"><img src="https://travis-ci.org/jonclayden/RNiftyReg.svg?branch=master" alt="Build Status"></a></li>
<li><a href="https://ci.appveyor.com/project/jonclayden/rniftyreg" class="external-link"><img src="https://ci.appveyor.com/api/projects/status/svcf7h0ehvmp2r9k?svg=true" alt="Build status"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Jon Clayden, Marc Modat, Benoit Presles, Thanasis Anthopoulos, Pankaj Daga.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
